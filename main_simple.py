import asyncio
import sys
from pathlib import Path
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
import uvicorn
from dotenv import load_dotenv
import os

# Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
load_dotenv()

# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
HOST = os.getenv("HOST", "127.0.0.1")
PORT = int(os.getenv("PORT", 8000))
DEBUG = os.getenv("DEBUG", "false").lower() == "true"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
Path("temp").mkdir(exist_ok=True)
Path("exports").mkdir(exist_ok=True)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"""
    print("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº YouTube Analyzer (ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)...")
    
    # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ” Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ°
    print("âš ï¸  Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ‘Ğ” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ° Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸")
    
    yield
    
    print("\nğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° YouTube Analyzer...")

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ FastAPI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
app = FastAPI(
    title="YouTube Content Analyzer",
    description="Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° YouTube ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸",
    version="1.0.0",
    lifespan=lifespan
)

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ API Ñ€Ğ¾ÑƒÑ‚ĞµÑ€
try:
    from api import api_router
    app.include_router(api_router, prefix="/api")
    print("âœ… API Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½")
except Exception as e:
    print(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ API: {e}")

# Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ (CSS, JS)
@app.get("/styles.css")
async def get_styles():
    if os.path.exists("styles.css"):
        return FileResponse("styles.css", media_type="text/css")
    return {"error": "styles.css not found"}

@app.get("/app.js")
async def get_app():
    if os.path.exists("app.js"):
        return FileResponse("app.js", media_type="application/javascript")
    return {"error": "app.js not found"}

# Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
@app.get("/")
async def get_index():
    if os.path.exists("index.html"):
        return FileResponse("index.html", media_type="text/html")
    return {"error": "index.html not found", "status": "Please check if all files are in place"}

# Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ endpoint
@app.get("/health")
async def health():
    return {
        "status": "ok",
        "version": "1.0.0",
        "message": "YouTube Analyzer is running (simplified mode)"
    }

if __name__ == "__main__":
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  YouTube Analyzer v1.0 (Simple Mode)  â•‘
    â•‘  Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚-ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    print(f"Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ° http://{HOST}:{PORT}")
    print("Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¾Ñ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ http://127.0.0.1:8000/health")
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
    uvicorn.run(
        app,
        host=HOST,
        port=PORT,
        reload=False,
        log_level="info"
    )